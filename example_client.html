<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Audio Transcription Client</title>
</head>
<body>
    <h1>WebSocket Audio Transcription</h1>
    <p>Status: <span id="status">Connecting...</span></p>
    <p>Transcription: <span id="transcription"></span></p>
    <button id="start">Start Recording</button>
    <button id="stop" disabled>Stop Recording</button>

    <script>
        const status = document.getElementById('status');
        const transcription = document.getElementById('transcription');
        const startButton = document.getElementById('start');
        const stopButton = document.getElementById('stop');
        let websocket;
        let mediaRecorder;
        let chunks = [];

        function connect() {
            websocket = new WebSocket('ws://localhost:8765');

            websocket.onopen = () => {
                status.textContent = 'Connected';
                startButton.disabled = false;
            };

            websocket.onclose = () => {
                status.textContent = 'Disconnected';
                startButton.disabled = true;
                stopButton.disabled = true;
            };

            websocket.onerror = (error) => {
                console.error('WebSocket error:', error);
                status.textContent = 'Error';
            };

            websocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'partial_transcript') {
                    transcription.textContent += data.text + ' ';
                } else if (data.type === 'final_transcript') {
                    transcription.textContent += '\nFinal: ' + data.text;
                } else if (data.type === 'error') {
                    transcription.textContent += '\nError: ' + data.message;
                }
            };
        }

        async function startRecording() {
            chunks = [];
            transcription.textContent = '';
            startButton.disabled = true;
            stopButton.disabled = false;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        chunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { 'type' : 'audio/webm; codecs=opus' });
                    const reader = new FileReader();
                    reader.onload = () => {
                        const buffer = reader.result;
                        websocket.send(JSON.stringify({ type: 'end_of_stream' }));
                    };
                    reader.readAsArrayBuffer(blob);
                };

                mediaRecorder.start();
                status.textContent = 'Recording...';
                sendAudioChunks();
            } catch (error) {
                console.error('Error starting recording:', error);
                status.textContent = 'Error: Could not start recording.';
                startButton.disabled = false;
                stopButton.disabled = true;
            }
        }

        async function sendAudioChunks() {
            if (mediaRecorder.state === 'recording') {
                const audioStream = new MediaStream();
                const audioTrack = mediaRecorder.stream.getAudioTracks()[0];
                audioStream.addTrack(audioTrack);

                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(audioStream);
                const processor = audioContext.createScriptProcessor(4096, 1, 1);

                source.connect(processor);
                processor.connect(audioContext.destination);

                processor.onaudioprocess = (event) => {
                    const inputData = event.inputBuffer.getChannelData(0);
                    const audioChunk = new Float32Array(inputData);
                    const int16Array = new Int16Array(audioChunk.length);
                    for (let i = 0; i < audioChunk.length; i++) {
                        int16Array[i] = Math.max(-1, Math.min(1, audioChunk[i])) * 32767; // Convert to int16
                    }
                    const audioChunkBytes = int16Array.buffer;
                    if (websocket.readyState === WebSocket.OPEN) {
                        websocket.send(JSON.stringify({ type: 'audio_chunk', data: Array.from(new Uint8Array(audioChunkBytes)) }));
                    }
                };
                setTimeout(sendAudioChunks, 1000); // Send chunks every 1 second
            }
        }

        function stopRecording() {
            mediaRecorder.stop();
            startButton.disabled = false;
            stopButton.disabled = true;
            status.textContent = 'Processing...';
        }

        connect();
        startButton.addEventListener('click', startRecording);
        stopButton.addEventListener('click', stopRecording);
    </script>
</body>
</html>